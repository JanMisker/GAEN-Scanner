<html>
<head>
  <title>GAEN scanner</title>
  <style type="text/css">
	  body {
		  font-family: monospace;
	  }
  </style>
  <script>
let cells = new Map();
let rpiMap = new Map();

function dataViewToHex(dataView) {
	const hexString = [...new Uint8Array(dataView.buffer)].map(b => {
    	return b.toString(16).padStart(2, '0');
  	}).join(' ');
	return hexString;
}

function startScan() {
	document.getElementById('scanButton').disabled = true;
	navigator.bluetooth.addEventListener('advertisementreceived', evt => {
		const deviceId = evt.device.id;
		evt.serviceData.forEach((dataView, key) => {
			const advData = dataViewToHex(dataView);
			if (!cells.has(deviceId)) {
				const tr = document.createElement('tr');
				const tdId = document.createElement('td');
				tdId.innerText = deviceId;
				tr.appendChild(tdId);
				const tdAdv = document.createElement('td');
				tdAdv.innerText = deviceId;
				tr.appendChild(tdAdv);
				cells.set(deviceId, tdAdv);
				document.getElementById('output').appendChild(tr);
				rpiMap.set(deviceId, new Set())
			}
			const rpis = rpiMap.get(deviceId);
			rpis.add(advData);
			const cell = cells.get(deviceId);
			cell.innerText = [...rpis].reduce((res,v) => `${res}\n${v}`);
		});
	});
	// const scan = navigator.bluetooth.requestLEScan({acceptAllAdvertisements: true});
	const scan = navigator.bluetooth.requestLEScan({ filters: [{ services: [0xfd6f] }] });
}

  </script>
</head>
<body>
<h1>Simple GAEN Scanner</h1>
<p>This page uses the Web Bluetooth API to scan for the GAEN BLE advertisement packets, containing a rolling proximity identifier. 
	I used the bluetooth specs pdf from this site: <a href="https://www.apple.com/covid19/contacttracing">Google Apple Exposure Notification Framework</a>.</p><p>Basically a Bluetooth Low Energy advertisement is broadcast, containing a service UUID of 0xfd6f, and a value with a 16 byte roling proximity identifier, and 4 bytes of versioning and signal strength. See the <a href="https://github.com/JanMisker/GAEN-Scanner">repository</a> for the code, it's all in index.html :)</p> 
<p><strong>Note:</strong> You must be using Chrome 79+ with the chrome://flags/#enable-experimental-web-platform-features flag enabled to try this out.</p>
<button onclick="startScan()" id="scanButton">Start scanning</button>
<table id="output">
<thead><tr><th>deviceId</th><th>discovered proximity IDs</th></thead>
</table>
</body>
</html>
