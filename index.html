<html>
<head>
  <title>GAEN Covid-19 tracing app scanner</title>
  <style type="text/css">
	  body {
		  font-family: monospace;
	  }
  </style>
  <script>
let cells = new Map();
let rpiMap = new Map();
let rssiMap = new Map();
	  
function dataViewToHex(dataView) {
	const hexString = [...new Uint8Array(dataView.buffer)].map(b => {
    	return b.toString(16).padStart(2, '0');
  	}).join(' ');
	return hexString;
}

function startScan() {
	document.getElementById('scanButton').disabled = true;
	navigator.bluetooth.addEventListener('advertisementreceived', evt => {
		const deviceId = evt.device.id;
		evt.serviceData.forEach((dataView, key) => {
			const advData = dataViewToHex(dataView);
			if (!cells.has(deviceId)) {
				const tr = document.createElement('tr');
				const tdId = document.createElement('td');
				tdId.innerText = deviceId;
				tr.appendChild(tdId);
				const tdRssi = document.createElement('td');
				tr.appendChild(tdRssi);
				const tdRpi = document.createElement('td');
				tr.appendChild(tdRpi);
				cells.set(deviceId, { name: tdId, rssi: tdRssi, rpi: tdRpi} );
				document.getElementById('output').appendChild(tr);
				rpiMap.set(deviceId, new Set())
			}
			const rpis = rpiMap.get(deviceId);
			rpis.add(advData);
			const cell = cells.get(deviceId);
			cell.rpi.innerText = [...rpis].reduce((res,v) => `${res}\n${v}`);
			cell.name.innerText = evt.device.name ? evt.device.name : deviceId;
			cell.rssi.innerText = evt.rssi;
		});
	});
	// const scan = navigator.bluetooth.requestLEScan({acceptAllAdvertisements: true});
	const scan = navigator.bluetooth.requestLEScan({ filters: [{ services: [0xfd6f] }] });
}

  </script>
</head>
<body>
<h1>Simple Covid-19 contact tracing app Scanner</h1>
<p>This page uses the Web Bluetooth API to scan for the GAEN BLE advertisement packets, containing a rolling proximity identifier. This proximity ID is the random number generated by apps based on the GAEN (Google+Apple Exposure Notification) framework that is designed to give notifications if you were in close proximity of another app-user that later got tested positive for Covid-19.
	I used the bluetooth specs pdf from the Apple documentation site of the: <a href="https://www.apple.com/covid19/contacttracing">Google Apple Exposure Notification Framework</a>.</p><p>Technical explanation: a Bluetooth Low Energy advertisement is broadcast, containing a service UUID of 0xfd6f, and a value with a 16 byte roling proximity identifier, and 4 bytes of versioning and signal strength. See the <a href="https://github.com/JanMisker/GAEN-Scanner">repository</a> for the code, it's all in index.html :)</p> 
<p><strong>Note:</strong> You must be using up-to-date Chrome (version 79 or higher) with the <a href="chrome://flags/#enable-experimental-web-platform-features">chrome://flags/#enable-experimental-web-platform-features</a> flag enabled to try this out, it is tested on macOS and Android, could be it doesn't work on Windows or Linux(?). Copy the link in location bar to enable the flag. Remember to put it back to disabled afterwards if you don't want to use experimental features.</p>
	<p>After clicking the button, a popup will appear asking for permission to use Bluetooth to do the scan. The <strong>rssi</strong> column is the signal strength, usually negative numbers. Higher number means stronger signal, so nearby devices will have rssi of for example -40, only when really next to each other the number becomes positive, in my observations.</p> 
<button onclick="startScan()" id="scanButton">Start scanning</button>
<table id="output">
	<thead><tr><th>device ID or name</th><th>rssi</th><th>discovered proximity IDs</th></thead>
</table>
</body>
</html>
